name: Upstream Sync Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  check-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/tiann/hapi || true
          git remote -v

      - name: Fetch upstream
        run: git fetch upstream main

      - name: Check for new commits
        id: check
        run: |
          # Count new commits
          COUNT=$(git log --oneline --no-merges main..upstream/main | wc -l)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          # Get merge base
          MERGE_BASE=$(git merge-base main upstream/main)
          echo "merge_base=$MERGE_BASE" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt 0 ]; then
            # Get commit list
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            git log --oneline --no-merges main..upstream/main >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Categorize commits
            echo "bug_fixes<<EOF" >> $GITHUB_OUTPUT
            git log --oneline --no-merges main..upstream/main | grep -E "^[a-f0-9]+ fix" || echo "None" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "features<<EOF" >> $GITHUB_OUTPUT
            git log --oneline --no-merges main..upstream/main | grep -E "^[a-f0-9]+ feat" || echo "None" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "docs<<EOF" >> $GITHUB_OUTPUT
            git log --oneline --no-merges main..upstream/main | grep -E "^[a-f0-9]+ docs" || echo "None" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Get file stats
            echo "file_stats<<EOF" >> $GITHUB_OUTPUT
            git diff --stat "$MERGE_BASE"..upstream/main | tail -5 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create or update issue
        if: steps.check.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const count = '${{ steps.check.outputs.count }}';
            const commits = `${{ steps.check.outputs.commits }}`;
            const bugFixes = `${{ steps.check.outputs.bug_fixes }}`;
            const features = `${{ steps.check.outputs.features }}`;
            const docs = `${{ steps.check.outputs.docs }}`;
            const fileStats = `${{ steps.check.outputs.file_stats }}`;
            const mergeBase = '${{ steps.check.outputs.merge_base }}';

            const title = `Weekly Upstream Sync: ${count} new commits available`;

            const body = `## üì¶ New Upstream Commits Available

            **Count**: ${count} new commits
            **Merge Base**: \`${mergeBase}\`
            **Review Date**: ${new Date().toISOString().split('T')[0]}

            ### üêõ Bug Fixes
            \`\`\`
            ${bugFixes}
            \`\`\`

            ### ‚ú® Features
            \`\`\`
            ${features}
            \`\`\`

            ### üìö Documentation
            \`\`\`
            ${docs}
            \`\`\`

            ### üìä File Change Summary
            \`\`\`
            ${fileStats}
            \`\`\`

            ---

            ### üîç Review Process

            1. **Fetch and review**:
               \`\`\`bash
               git fetch upstream main
               git log --stat main..upstream/main
               \`\`\`

            2. **Run check script**:
               \`\`\`bash
               ./scripts/check-upstream.sh
               \`\`\`

            3. **Start sync branch**:
               \`\`\`bash
               git checkout -b upstream-sync-$(date +%Y-%m-%d)
               \`\`\`

            4. **Cherry-pick commits**:
               \`\`\`bash
               git cherry-pick -x <commit-hash>
               \`\`\`

            ### üìã Resources

            - [Upstream Sync Strategy](../blob/main/UPSTREAM_SYNC_STRATEGY.md)
            - [Upstream Sync Log](../blob/main/UPSTREAM_SYNC_LOG.md)
            - [Upstream Repository](https://github.com/tiann/hapi)

            ### ‚úÖ Checklist

            - [ ] Reviewed all new commits
            - [ ] Identified commits to cherry-pick
            - [ ] Created sync branch
            - [ ] Cherry-picked selected commits
            - [ ] Resolved any conflicts
            - [ ] Ran tests
            - [ ] Updated UPSTREAM_SYNC_LOG.md
            - [ ] Created PR for review
            `;

            // Search for existing open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync',
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.startsWith('Weekly Upstream Sync:')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                title: title,
                body: body,
              });

              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `üîÑ Updated with ${count} new commits (${new Date().toISOString().split('T')[0]})`,
              });

              core.info(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'needs-review'],
              });

              core.info(`Created new issue #${issue.data.number}`);
            }

      - name: Post summary
        if: steps.check.outputs.count > 0
        run: |
          echo "## Upstream Sync Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîî **${{ steps.check.outputs.count }} new commits** available from upstream" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An issue has been created/updated with details." >> $GITHUB_STEP_SUMMARY
          echo "See [UPSTREAM_SYNC_STRATEGY.md](UPSTREAM_SYNC_STRATEGY.md) for the sync process." >> $GITHUB_STEP_SUMMARY

      - name: No new commits summary
        if: steps.check.outputs.count == 0
        run: |
          echo "## Upstream Sync Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ No new commits from upstream" >> $GITHUB_STEP_SUMMARY
