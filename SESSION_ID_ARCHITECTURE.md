# Session ID Architecture

## Overview

The hapi system uses **two different session IDs** that serve distinct purposes. Understanding this duality is critical for working with the resume feature.

## The Two Session IDs

### 1. Hapi Session ID

**Purpose:** User-facing identifier for the session in hapi's system

**Characteristics:**
- Generated by hapi server when session is created (`randomUUID()`)
- Stored in database as `sessions.id`
- Shown in UI and URLs (`/sessions/{hapi-session-id}`)
- Used for RPC method registration (`{hapi-session-id}:methodName`)
- **Stays constant across resume operations**

**Location in Code:**
- `session.id` in database and in-memory cache
- URL parameter in web routes: `/sessions/:id`
- RPC method prefix: `{sessionId}:resumeSession`

### 2. Claude Session ID

**Purpose:** Claude CLI's internal identifier for conversation history

**Characteristics:**
- Generated by Claude CLI when session starts
- Stored in `sessions.metadata.claudeSessionId`
- Used to locate Claude's session files (`~/.claude/projects/.../session-id.jsonl`)
- **May change when using `--resume` flag**

**Location in Code:**
- `metadata.claudeSessionId` in database
- Passed to Claude CLI as `--resume {claude-session-id}`
- Reported back via `SessionStart` hook

## Session ID Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         Initial Session Creation                 │
└─────────────────────────────────────────────────────────────────┘

User clicks "New Session"
         │
         ▼
Server generates hapi-session-id: "abc-123"
         │
         ▼
Server spawns CLI process
         │
         ▼
CLI runs `claude` (no --resume)
         │
         ▼
Claude creates claude-session-id: "xyz-789"
         │
         ▼
Claude sends SessionStart hook → hapiSessionId: "abc-123", claudeSessionId: "xyz-789"
         │
         ▼
Server stores:
  - session.id = "abc-123"
  - session.metadata.claudeSessionId = "xyz-789"
         │
         ▼
User interacts with session "abc-123" in UI


┌─────────────────────────────────────────────────────────────────┐
│                      Resume: CLI Still Running                   │
└─────────────────────────────────────────────────────────────────┘

User clicks "Resume" on session "abc-123"
         │
         ▼
Server checks: session.active = false
         │
         ▼
Server tries RPC: resumeSession("abc-123")
         │
         ▼
CLI process responds: "I'm still here!"
         │
         ▼
Session marked active again
         │
         ▼
✅ Same hapi-session-id: "abc-123"
✅ Same claude-session-id: "xyz-789"
✅ No spawn, no redirect


┌─────────────────────────────────────────────────────────────────┐
│                       Resume: CLI Exited                         │
└─────────────────────────────────────────────────────────────────┘

User clicks "Resume" on session "abc-123"
         │
         ▼
Server checks: session.active = false
         │
         ▼
Server tries RPC: resumeSession("abc-123")
         │
         ▼
RPC fails: "handler not registered"
         │
         ▼
Server spawns new CLI with:
  --hapi-session-id "abc-123"
  --resume-claude-session "xyz-789"
         │
         ▼
CLI joins hapi session "abc-123"
         │
         ▼
CLI runs `claude --resume xyz-789`
         │
         ▼
Claude loads history from "xyz-789"
Claude creates NEW session: "xyz-999"  ← New Claude ID!
Claude copies all messages to new session
Claude rewrites all message IDs to "xyz-999"
         │
         ▼
Claude sends SessionStart hook → hapiSessionId: "abc-123", claudeSessionId: "xyz-999"
         │
         ▼
Server updates:
  - session.id = "abc-123"  (unchanged)
  - session.metadata.claudeSessionId = "xyz-999"  (updated!)
         │
         ▼
User continues in session "abc-123"
         │
         ▼
✅ Same hapi-session-id: "abc-123" (no redirect)
⚠️  New claude-session-id: "xyz-999" (history preserved)
```

## Session ID Mapping Over Time

A single hapi session can have multiple Claude sessions over its lifetime:

```
Hapi Session: abc-123
├─ Initial:      claude-session-id = xyz-789
├─ Resume #1:    claude-session-id = xyz-888
├─ Resume #2:    claude-session-id = xyz-999
└─ Resume #3:    claude-session-id = xyz-111
```

**Important:** There is currently **no lineage tracking**. We only store the latest Claude session ID.

## Code Locations

### Server Side

**syncEngine.ts**
- `resumeSession(sessionId)` - Takes **hapi session ID**
- `spawnWithResume(session)` - Uses both IDs:
  - `session.id` → hapi session ID (stays constant)
  - `metadata.claudeSessionId` → Claude session ID (to resume from)

**rpcGateway.ts**
- `resumeSession(sessionId)` - Takes **hapi session ID**
- `spawnResumedSession(hapiSessionId, ..., claudeSessionIdToResume)` - Takes BOTH IDs

**sessions.ts (Web Routes)**
- `POST /sessions/:id/resume` - `:id` is **hapi session ID**

### CLI Side

**commands/claude.ts**
- `--hapi-session-id` - Hapi session ID to join
- `--resume-claude-session` - Claude session ID to resume from

**sessionFactory.ts**
- `bootstrapSession({ tag, resumeClaudeSession })`:
  - `tag` → hapi session ID
  - `resumeClaudeSession` → Claude session ID

**runClaude.ts**
- Adds `--resume {resumeClaudeSession}` to Claude args

## Best Practices

### When Writing Code

1. **Always document which ID you're using**
   ```typescript
   // ✅ Good
   async function resumeSession(hapiSessionId: string): Promise<void>

   // ❌ Bad
   async function resumeSession(sessionId: string): Promise<void>
   ```

2. **Use descriptive variable names**
   ```typescript
   // ✅ Good
   const hapiSessionId = session.id
   const claudeSessionId = metadata.claudeSessionId

   // ❌ Bad
   const id1 = session.id
   const id2 = metadata.claudeSessionId
   ```

3. **Add JSDoc comments explaining the duality**
   ```typescript
   /**
    * @param hapiSessionId - The hapi session ID (stays constant)
    * @param claudeSessionId - The Claude session ID (may change)
    */
   ```

### When Debugging

1. **Check both IDs in logs**
   ```typescript
   logger.info('Resuming session', {
       hapiSessionId: session.id,
       claudeSessionId: metadata.claudeSessionId
   })
   ```

2. **Remember: Hapi ID in URL ≠ Claude ID in files**
   - URL shows: `/sessions/abc-123`
   - Files at: `~/.claude/projects/.../xyz-789.jsonl`

3. **If session history seems wrong, check Claude session ID**
   - Multiple resumes = multiple Claude sessions
   - Current Claude ID in `metadata.claudeSessionId`
   - Old Claude session files may still exist on disk

## Common Pitfalls

### ❌ Pitfall 1: Assuming session ID is unique

```typescript
// BAD: This will find multiple sessions over time
const sessions = await findAllByClaudeSessionId(claudeId)
```

**Why:** One hapi session can have multiple Claude session IDs.

**Fix:** Use hapi session ID as the primary key.

### ❌ Pitfall 2: Not updating metadata.claudeSessionId

```typescript
// BAD: Spawning with --resume but not updating metadata
await spawnWithResume(oldClaudeSessionId)
// Session now has wrong claudeSessionId in database!
```

**Why:** Claude creates a new session ID when resuming.

**Fix:** Let the SessionStart hook update `metadata.claudeSessionId`.

### ❌ Pitfall 3: Redirecting to new session after resume

```typescript
// BAD: Creating new hapi session on resume
const newHapiSessionId = randomUUID()
await spawnSession(newHapiSessionId)
return redirect(`/sessions/${newHapiSessionId}`)
```

**Why:** Breaks user's mental model (they were on session X, now on session Y).

**Fix:** Reuse existing hapi session ID, only Claude session ID changes.

## Future Considerations

### Session Lineage Tracking

Currently we don't track the chain of Claude sessions. Potential improvement:

```typescript
interface SessionMetadata {
    claudeSessionId: string           // Current Claude session
    claudeSessionLineage: string[]    // All previous Claude sessions
    resumeCount: number                // How many times resumed
}
```

### Session Adoption / Handoff

Future feature: Connecting to existing Claude sessions not managed by hapi.

This would require:
1. User provides Claude session ID
2. System creates new hapi session
3. System links them together
4. System adopts the Claude session's history

## Summary

- **Hapi Session ID**: User-facing, stable, in database and UI
- **Claude Session ID**: Internal, may change, in metadata and files
- **Resume behavior**: Hapi ID stays same, Claude ID may change
- **User experience**: No redirects, seamless continuation
- **Architecture trade-off**: Simplicity vs. lineage tracking
